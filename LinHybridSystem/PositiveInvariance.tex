
Our objective is to find positive invariants whose projection in every
location is a augmented complex zonotope.  We use a template based
approach, where we fix suitable primary and secondary templates and
then find corresponding primary offsets, scaling factors and
sub-parallelotopic bounds to get a positive invariant.  We choose the
the primary template $V(\loc)\in\mat{n}{m(q)}{\mb{C}}$ in a
location $\loc\in\locationset$ such
that
%\begin{equation}~\label{eqn:tempselect}
$\ptemplate(\loc)V(\loc) = 0$,
%\end{equation}  
so that intersection with the sub-parallelotopic staying and guard
conditions can be conveniently computed, based on
Lemma~\ref{lem:intersection}.  Another consideration for choosing the
primary template is the eigenstructure of the linear
maps, that is discussed in a latter section.


The following lemmas state sufficient conditions for satisfaction of
the inclusion relations for positive invariance~(\ref{eqn:PosInv}) by
an augmented complex zonotope, whose template is chosen as specified
above.
\begin{lemma}
  Let us consider a state set $\hybridset$ whose projection in each
  location $\loc\in\locationset$ is $\hybridset(\loc) =
  \real\lt(\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$
  such that $\ptemplate(\loc)V(\loc) = 0$.  Let us consider that the
  additive input in each location $\loc\in\locationset$ can be
  overapproximated as $\inputset(\loc) = \cz{B_{n\times
      m^\pr(q)}(\loc)}{b(\loc)}{r(\loc)}$.  Then the inclusion
  $\locationtransition{\loc}\lt(\hybridset(\loc)\rt) \subseteq
  \hybridset\lt(\loc\rt)$ holds if,
\begin{align}
\begin{split}~\label{eqn:exists-intra}
& \exists
  X(\loc)\in\mat{\lt(m(\loc)+k(\loc)\rt)}{\lt(m(\loc)+k(\loc)+m^\pr(\loc)\rt)}{\mb{C}},~
  y(\loc)\in\mb{C}^{m(\loc)+k(\loc)}\\&~u^\pr(\loc),l^\pr(\loc)\in\realset^{k(\loc)}~\text{and}~s^\pr(\loc)\in\realset^{k(\loc)}~\text{and policies}\\
&\minaffinefunc_{\loc}^{pre}\in\minaffineset\lt(k\lt(\loc\rt)\rt),\maxaffinefunc_{\loc}^{pre}\in\maxaffineset\lt(k\lt(\loc\rt)\rt),
\minaffinefunc_{\loc}^{post}\in\minaffineset\lt(k\lt(\loc\rt)\rt),\maxaffinefunc_{\loc}^{post}\in\maxaffineset\lt(k\lt(\loc\rt)\rt),~\text{s.t.}
\end{split}
\end{align}
\begin{align}
\begin{split}
& \left[V(\loc),~\pinv{\ptemplate}(\loc)\rt]X(\loc) =
  [AV(\loc),~A\pinv{\ptemplate}(\loc),~B(\loc)]\dg\lt(\cjoin{s(\loc)}{s^\pr(\loc)}{r(\loc)}\rt)\\
\end{split}
\end{align}
\begin{align}
\begin{split}
& s^\pr(\loc) = \frac{\minaffinefunc_{\loc}^{pre}\lt(\stay^+(\loc),u(\loc)\rt)
      -\maxaffinefunc_{\loc}^{pre}\lt(\stay^-(\loc),l(\loc)\rt)}{2}
\end{split}
\end{align}
\begin{align}
\begin{split}
  & \left[V(\loc),~~\pinv{\ptemplate}(\loc)\rt]y(\loc) = 
    \map(\loc)\lt(c(\loc)+\pinv{\ptemplate}(\loc)\frac{\minaffinefunc_{\loc}^{pre}\lt(\stay^+(\loc),u(\loc)\rt)
     +\maxaffinefunc_{\loc}^{pre}\lt(\stay^-(\loc),l(\loc)\rt)}{2}\rt)\\ & \hspace{10em} +
  b(\loc)-c(\loc)-\pinv{\ptemplate}(\loc)\frac{u^\pr(\loc)+l^\pr(\loc)}{2}
\end{split}
\end{align}
\begin{align}
\begin{split}
& \forall
i\in\tup{m(\loc)},~\lt|y_i(\loc)\rt|+\sum_{i=1}^{m(\loc)+k(\loc)+m^\pr(\loc)}\lt|X_{ij}(\loc)\rt|\leq
s_i(\loc),
\end{split}
\end{align}
\begin{align}
\begin{split}
& \forall
i\in\lt\{m(\loc)+1,...,m(\loc)+k(\loc)\rt\},\\
&\lt|y_i(\loc)\rt|+\sum_{i=1}^{m(\loc)+k(\loc)+m^\pr(\loc)}\lt|X_{ij}(\loc)\rt|\leq
\frac{u^\pr(\loc)-l^\pr(\loc)}{2}
\end{split}
\end{align}
\begin{align}
& l^\pr(\loc)\leq u^\pr(\loc)\\
\begin{split}
& \maxaffinefunc_{\loc}^{post}\lt(l^\pr(\loc),\stay^-(\loc)\rt)\geq
l(\loc)~\text{and}~\minaffinefunc_{\loc}^{post}\lt(u^\pr(\loc),\stay^+(\loc)\rt)\leq u(\loc).
\end{split}
\end{align}
\end{lemma}
\begin{proof}
{\color{red} TODO}
\end{proof}

\begin{lemma}
  Let us consider a state set $\hybridset$ whose projection in each
  location $\loc\in\locationset$ is $\hybridset(\loc) =
  \real\lt(\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$
  such that $\ptemplate(\loc)V(\loc) = 0$.  Then for an edge
  $\edge\in\edgeset$, the inclusion
  $\edgetransition{\edge}\lt(\hybridset\lt(\preloc{\edge}\rt)\rt)
  \subseteq \hybridset\lt(\postloc{\edge}\rt)$ holds if,
\begin{align}
\begin{split}
& \exists X(\edge)\in
\mat{\lt(m\lt(\postloc{\edge}\rt)+k\lt(\postloc{\edge}\rt)\rt)}{\lt(m\lt(\preloc{\edge}\rt)+k\lt(\preloc{\edge}\rt)\rt)}{\mb{C}}~\text{and}~y(\edge)\in
\mb{C}^{m\lt(\postloc{\edge}\rt)+k\lt(\postloc{\edge}\rt)},\\
& \exists u^\pr(\edge),l^\pr(\edge)\in \realset^{k\lt(\postloc{\edge}\rt)}, c^\pr(\sigma)\in\mb{R}^n,s^\pr(\edge)\in\realset^{k\lt(\preloc{\edge}\rt)}~\text{and policies}\\
&\minaffinefunc_{\edge}^{pre}\in\minaffineset\lt(k\lt(\preloc{\edge}\rt)\rt),\maxaffinefunc_{\edge}^{pre}\in\maxaffineset\lt(k\lt(\preloc{\edge}\rt)\rt),
\minaffinefunc_{\edge}^{post}\in\minaffineset\lt(k\lt(\postloc{\edge}\rt)\rt),\maxaffinefunc_{\edge}^{post}\in\maxaffineset\lt(k\lt(\postloc{\edge}\rt)\rt),~\text{s.t.}
\end{split}\\
\begin{split}
& \lt[V\lt(\postloc{\edge}\rt),~\pinv{\ptemplate}\lt(\postloc{\edge}\rt)\rt]X(\edge) = \reset{\edge}\lt[V\lt(\preloc{\edge}\rt),~\pinv{\ptemplate}\lt(\preloc{\edge}\rt)\rt]\dg
\ColumnJoin{s\lt(\preloc{\edge}\rt)}{s^\pr(\edge)}\\
\end{split}
\end{align}
\begin{align}
\begin{split}
s^\pr(\edge) = \frac{\minaffinefunc_{\edge}^{pre}\lt(u\lt(\preloc{\edge}\rt),\min\lt(\stay^+\lt(\preloc{\edge}\rt),\edge^+\rt)\rt)-
\maxaffinefunc_{\edge}^{pre}\lt(l\lt(\preloc{\edge}\rt),\max\lt(\stay^-\lt(\preloc{\edge}\rt),\edge^-\rt)\rt)}{2}\\
\end{split}
\end{align}
\begin{align}
\begin{split}
& \lt[V\lt(\postloc{\edge}\rt),~\pinv{\ptemplate}\lt(\postloc{\edge}\rt)\rt]y(\edge) = \reset{\edge}\lt(c\lt(\preloc{\edge}\rt)+c^\pr(\edge)\rt)- 
c\lt(\postloc{\edge}\rt) - \pinv{\ptemplate}\lt(\postloc{\edge}\rt)\frac{u^\pr\lt(\edge\rt)+l^\pr\lt(\edge\rt)}{2}\\
\end{split}
\end{align}
\begin{align}
\begin{split}
& c^\pr(\edge) = \pinv{\ptemplate}\lt(\preloc{\edge}\rt)\frac{\minaffinefunc_{\edge}^{pre}\lt(u\lt(\preloc{\edge}\rt),\min\lt(\stay^+\lt(\preloc{\edge}\rt),\edge^+\rt)\rt)+
\maxaffinefunc_{\edge}^{pre}\lt(l\lt(\preloc{\edge}\rt),\max\lt(\stay^-\lt(\preloc{\edge}\rt),\edge^-\rt)\rt)}{2}
\end{split}
\end{align}
\begin{align}
\begin{split}
& \forall i\in \tup{m\lt(\postloc{\edge}\rt)}:
 \lt|y_i(\edge)\rt|+\sum_{j=1}^{m\lt(\preloc{\edge}\rt)+k\lt(\preloc{\edge}\rt)}\lt|X_{ij}(\edge)\rt|\leq s_i\lt(\postloc{\edge}\rt)
\end{split}\\
\begin{split}
& \forall i\in
\lt\{m\lt(\postloc{\edge}\rt)+1,...,m\lt(\postloc{\edge}\rt)+k\lt(\postloc{\edge}\rt)\rt\}:\\
&\lt|y_i(\edge)\rt|+\sum_{j=1}^{m\lt(\preloc{\edge}\rt)+k\lt(\preloc{\edge}\rt)}\lt|X_{ij}(\edge)\rt|\leq \frac{u^\pr_i\lt(\edge\rt)-l^\pr_i\lt(\edge\rt)}{2}
\end{split}\\
\begin{split}
l^\pr(\edge)\leq u^\pr(\edge)
\end{split}\\
& \maxaffinefunc_{\edge}^{post}\lt(l^\pr(\edge),\stay^-\lt(\postloc{\edge}\rt)\rt)\geq
l\lt(\postloc{\edge}\rt)~\text{and}~\minaffinefunc_{\edge}^{post}\lt(u^\pr(\edge),\stay^+\lt(\postloc{\edge}\rt)\rt)\leq u\lt(\postloc{\edge}\rt).
\end{align}
\end{lemma}
\begin{proof}
{\color{red} TODO}
\end{proof}

Additionally, we may want the positive invariant to contain an initial
set.  So, the following lemma states the sufficient condition for
containing an initial set which can be overapproximated by an
augmented complex zonotope.
\begin{lemma}
  Let us consider a two state sets $\mc{I}$ and $\hybridset$ whose projections in each location
  $\loc\in\locationset$ are respectively $\mc{I}(\loc)=\real\lt(\gcz{V^I_{n\times
      m^\pr }}{c^I(\loc)}{s^I(\loc)}{W_{n\times
      k^\pr}}{l^I(\loc)}{u^I(\loc)}\rt)$ and $\hybridset(\loc) =
  \gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}$.
  Then
  $\forall\loc\in\locationset,~\mc{I}(\loc)\subseteq \hybridset(\loc)$
  if $\forall\loc\in\locationset$, 
\begin{align}
\begin{split}
& \exists X^I(\loc)\in\mat{(m(\loc)+k(\loc))}{(m^\pr+k^\pr)}{\mb{C}}~\text{and}~y^I\in\mb{C}^{m(\loc)+k(\loc)}~s.t.\\
& \lt[V,~\pinv{\ptemplate}(\loc)\rt]X^I = \lt[V^I~W\rt]\dg\ColumnJoin{\hspace{0.5em}s^I(\loc)}{\frac{u^I(\loc)-l^I(\loc)}{2}}\\
& \lt[V,~\pinv{\ptemplate}(\loc)\rt]y^I =
c^I(\loc)+W\frac{u^I(\loc)+l^I(\loc)}{2}-c(\loc)-\pinv{\ptemplate}(\loc)\frac{u(\loc)+l(\loc)}{2}\\
& \forall i\in\tup{m(\loc)},
\lt|y_i^I\rt|+\sum_{j=1}^{m^\pr+k^\pr}\lt|X_{ij}^I\rt|\leq s_i(\loc)\\
& \forall
i\in\lt\{m(\loc)+k(\loc)\rt\},\lt|y_i^I\rt|+\sum_{j=1}^{m^\pr+k^\pr}\lt|X_{ij}^I\rt|\leq \frac{u_i(\loc)-l_i(\loc)}{2}
\end{split}
\end{align}
\end{lemma}

One of the applications of positive invariants is to prove safety.  If
a positive invariant, containing an initial set, is contained inside a
safe set, then the system is safe.  In this regard, the following
lemma states a sufficient condition for an augmented complex zonotope
to be contained within a polytopic safe set.

\begin{lemma}
  Let us consider a state set $\hybridset$ whose projection in each
  location $\loc \in\locationset$ is $\hybridset(\loc) =
  \real\lt(\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$.
  Let us consider a polytopic state set
  $\mc{J}:\locationset\ra\realset^n$ described as $\forall
  \loc\in\locationset,~\mc{J}(\loc)=\lt\{x\in\realset^n:Tx\leq
  d(\loc)\rt\}$, where $T\in\mat{p}{n}{R}$ and
  $d(\loc)\in\comprealset^n$.  Then $\forall\loc\in\locationset$,
  $\hybridset(\loc)\subseteq \mc{J}(\loc)$ if $\forall
  q\in\locationset$,
\begin{align}~\label{eqn:safe-contain}
T\lt(c+W\lt(\frac{u(\loc)+l(\loc)}{2}\rt)\rt)+\lt|T\lt[V(\loc),~\pinv{\ptemplate}(\loc)\rt]\rt|\ColumnJoin{\hspace{2em}s}{\frac{u(\loc)-l(\loc)}{2}}\leq d(\loc).
\end{align}
\end{lemma}

Consolidating all the above results, the following theorem states a
sufficient condition for a state set, having augmented complex
zonotopic projections in all locations, to be a positive invariant.
Additionally, we include sufficient conditions such that the state set is
contained within a polytopic safe set and contains an initial set.

\begin{theorem}~\label{thm:main} Let us consider a state set
  $\hybridset$ whose projection in each location $\loc\in\locationset$
  is $\hybridset(\loc) =
  \gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}$
  such that $\ptemplate(\loc)V(\loc) = 0$.  Let a state set $\mc{I}$
  where $\forall\loc\in\locationset$,
  $\mc{I}(\loc)=\real\lt(\gcz{V^I_{n\times
      m^\pr }}{c^I(\loc)}{s^I(\loc)}{W_{n\times
      k^\pr}}{l^I(\loc)}{u^I(\loc)}\rt)$ be the initial state set.  Let $T\in\mat{p}{n}{R}$ and
  $\forall\loc\in\locationset,~d(\loc)\in\comprealset^n$.  A safe set
  is given by a polytopic
  state set $\mc{J}:\locationset\ra\realset^n$ described as $\forall
  \loc\in\locationset,~\mc{J}(\loc)=\lt\{x\in\realset^n:Tx\leq
  d(\loc)\rt\}$.  Then $\hybridset$ is a positive
  invariant and $\forall
  \loc\in\locationset,~\mc{I}(\loc)\subseteq\hybridset(\loc)\subseteq
  \mc{J}(\loc)$, if $\forall \loc\in\locationset$ and $\forall
  \edge\in\edgeset$,
  Equations[\ref{eqn:exists-intra}-\ref{eqn:safe-contain}] are all
  satisfied.
\end{theorem}