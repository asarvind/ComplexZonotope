
Our objective is to find positive invariants whose projection in every
location is a generalized complex zonotope.  We use a template based
approach, where we fix suitable primary and secondary templates and
then find corresponding primary offsets, scaling factors and
sub-parallelotopic bounds to get a positive invariant.  We choose the
the primary template $V(\loc)\in\mat{n}{m(q)}{\mb{C}}$ in a
location $\loc\in\locationset$ such
that
%\begin{equation}~\label{eqn:tempselect}
$\ptemplate(\loc)V(\loc) = 0$,
%\end{equation}  
so that intersection with the sub-parallelotopic staying and guard
conditions can be conveniently computed, based on
Lemma~\ref{lem:intersection}.  Another consideration for choosing the
primary template is the eigenstructure of the linear
maps, that is discussed in a latter section.


We state in the following lemmas sufficient conditions for satisfaction of inclusions
of~(\ref{eqn:PosInv}) by a generalized complex zonotopes,
whose templates are chosen as above.
\begin{lemma}
  Let us consider a state set $\hybridset$ whose projection in each
  location $\loc\in\locationset$ is $\hybridset(\loc) =
  \gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}$
  such that $\ptemplate(\loc)V(\loc) = 0$.  Let us consider that the
  additive input in each location $\loc\in\locationset$ can be
  overapproximated as $\inputset(\loc) = \cz{B_{n\times
      m^\pr(q)}(\loc)}{b(\loc)}{r(\loc)}$.  Then the inclusion
  $\locationtransition{\loc}\lt(\hybridset(\loc)\rt) \subseteq
  \hybridset\lt(\loc\rt)$ holds if,
\begin{align}
\begin{split}
& \exists
  X(\loc)\in\mat{\lt(m(\loc)+k(\loc)\rt)}{\lt(m(\loc)+k(\loc)+m^\pr(\loc)\rt)}{\mb{C}},~
  y(\loc)\in\mb{C}^{m(\loc)+k(\loc)}\\&~u^\pr(\loc),l^\pr(\loc)\in\realset^{k(\loc)}~\text{and}~s^\pr(\loc)\in\realset^{k(\loc)}~text{and policies}\\
&\minaffinefunc_{\loc}^{pre}\in\minaffineset\lt(k\lt(\loc\rt)\rt),\maxaffinefunc_{\loc}^{pre}\in\maxaffineset\lt(k\lt(\loc\rt)\rt),
\minaffinefunc_{\loc}^{post}\in\minaffineset\lt(k\lt(\loc\rt)\rt),\maxaffinefunc_{\loc}^{post}\in\maxaffineset\lt(k\lt(\loc\rt)\rt),~\text{s.t.}
\end{split}\\
\begin{split}
& \left[V(\loc),~W(\loc)\rt]X(\loc) =
  [AV(\loc),~AW(\loc),~B(\loc)]\dg\lt(\cjoin{s(\loc)}{s^\pr(\loc)}{r(\loc)}\rt)\\
\end{split}\\
\begin{split}
& s^\pr(\loc) = \frac{\minaffinefunc_{\loc}^{pre}\lt(\stay^+(\loc),u(\loc)\rt)
      -\maxaffinefunc_{\loc}^{pre}\lt(\stay^-(\loc),l(\loc)\rt)}{2}
\end{split}\\
\begin{split}
  & \left[V(\loc),~~W(\loc)\rt]y(\loc) = 
    \map(\loc)\lt(c(\loc)+W(\loc)\frac{\minaffinefunc_{\loc}^{pre}\lt(\stay^+(\loc),u(\loc)\rt)
     +\maxaffinefunc_{\loc}^{pre}\lt(\stay^-(\loc),l(\loc)\rt)}{2}\rt)\\ & \hspace{10em} +
  b(\loc)-c(\loc)-W(\loc)\frac{u^\pr(\loc)+l^\pr(\loc)}{2}
\end{split}\\
\begin{split}
& \forall
i\in\tup{m(\loc)},~\lt|y_i(\loc)\rt|+\sum_{i=1}^{m(\loc)+k(\loc)+m^\pr(\loc)}\lt|X_{ij}(\loc)\rt|\leq
s_i(\loc),
\end{split}\\
\begin{split}
& \forall
i\in\lt\{m(\loc)+1,...,m(\loc)+k(\loc)\rt\},\\
&\lt|y_i(\loc)\rt|+\sum_{i=1}^{m(\loc)+k(\loc)+m^\pr(\loc)}\lt|X_{ij}(\loc)\rt|\leq
\frac{u^\pr(\loc)-l^\pr(\loc)}{2}
\end{split}\\
& l^\pr(\loc)\leq u^\pr(\loc)\\
\begin{split}
& \maxaffinefunc_{\loc}^{post}\lt(l^\pr(\loc),\stay^-(\loc)\rt)\geq
l(\loc)~\text{and}~\minaffinefunc_{\loc}^{post}\lt(u^\pr(\loc),\stay^+(\loc)\rt)\leq u(\loc).
\end{split}
\end{align}
\end{lemma}
\begin{proof}
{\color{red} TODO}
\end{proof}

\begin{lemma}
  Let us consider a state set $\hybridset$ whose projection in each
  location $\loc\in\locationset$ is $\hybridset(\loc) =
  \gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}$
  such that $\ptemplate(\loc)V(\loc) = 0$.  Then for any edge
  $\edge\in\edgeset$, the inclusion
  $\edgetransition{\edge}\lt(\hybridset\lt(\preloc{\edge}\rt)\rt)
  \subseteq \hybridset\lt(\postloc{\edge}\rt)$ holds if,
\begin{align}
\begin{split}
& \exists X(\edge)\in
\mat{\lt(m\lt(\postloc{\edge}\rt)+k\lt(\postloc{\edge}\rt)\rt)}{\lt(m\lt(\preloc{\edge}\rt)+k\lt(\preloc{\edge}\rt)\rt)}{\mb{C}}~\text{and}~y(\edge)\in
\mb{C}^{m\lt(\postloc{\edge}\rt)+k\lt(\postloc{\edge}\rt)},\\
& \exists u^\pr(\edge),l^\pr(\edge)\in \realset^{k\lt(\postloc{\edge}\rt)}, c^\pr(\sigma)\in\mb{R}^n,s^\pr(\edge)\in\realset^{k\lt(\preloc{\edge}\rt)}~\text{and policies}\\
&\minaffinefunc_{\edge}^{pre}\in\minaffineset\lt(k\lt(\preloc{\edge}\rt)\rt),\maxaffinefunc_{\edge}^{pre}\in\maxaffineset\lt(k\lt(\preloc{\edge}\rt)\rt),
\minaffinefunc_{\edge}^{post}\in\minaffineset\lt(k\lt(\postloc{\edge}\rt)\rt),\maxaffinefunc_{\edge}^{post}\in\maxaffineset\lt(k\lt(\postloc{\edge}\rt)\rt),~\text{s.t.}
\end{split}\\
\begin{split}
& \lt[V\lt(\postloc{\edge}\rt),~W\lt(\postloc{\edge}\rt)\rt]X(\edge) = \reset{\edge}\lt[V\lt(\preloc{\edge}\rt),~W\lt(\preloc{\edge}\rt)\rt]\dg
\ColumnJoin{s\lt(\preloc{\edge}\rt)}{s^\pr(\edge)}\\
\end{split}
\end{align}
\begin{align}
\begin{split}
s^\pr(\edge) = \frac{\minaffinefunc_{\edge}^{pre}\lt(u\lt(\preloc{\edge}\rt),\min\lt(\stay^+\lt(\preloc{\edge},\edge^+\rt)\rt)\rt)-
\maxaffinefunc_{\edge}^{pre}\lt(l\lt(\preloc{\edge}\rt),\max\lt(\stay^-\lt(\preloc{\edge},\edge^-\rt)\rt)\rt)}{2}\\
\end{split}
\end{align}
\begin{align}
\begin{split}
& \lt[V\lt(\postloc{\edge}\rt),~W\lt(\postloc{\edge}\rt)\rt]y(\edge) = \reset{\edge}\lt(c\lt(\preloc{\edge}\rt)+c^\pr(\edge)\rt)- 
c\lt(\postloc{\edge}\rt) - W\lt(\postloc{\edge}\rt)\frac{u^\pr\lt(\edge\rt)+l^\pr\lt(\edge\rt)}{2}\\
\end{split}
\end{align}
\begin{align}
\begin{split}
& c^\pr(\edge) = W\lt(\preloc{\edge}\rt)\frac{\minaffinefunc_{\edge}^{pre}\lt(u\lt(\preloc{\edge}\rt),\min\lt(\stay^+\lt(\preloc{\edge},\edge^+\rt)\rt)\rt)+
\maxaffinefunc_{\edge}^{pre}\lt(l\lt(\preloc{\edge}\rt),\max\lt(\stay^-\lt(\preloc{\edge},\edge^-\rt)\rt)\rt)}{2}
\end{split}
\end{align}
\begin{align}
\begin{split}
& \forall i\in \tup{m\lt(\postloc{\edge}\rt)}:
 \lt|y_i\rt|+\sum_{j=1}^{m\lt(\preloc{\edge}\rt)+k\lt(\preloc{\edge}\rt)}\lt|X_{ij}\rt|\leq s_i\lt(\postloc{\edge}\rt)
\end{split}\\
\begin{split}
& \forall i\in
\lt\{m\lt(\postloc{\edge}\rt)+1,...,m\lt(\postloc{\edge}\rt)+k\lt(\postloc{\edge}\rt)\rt\}:
\lt|y_i\rt|+\sum_{j=1}^{m\lt(\preloc{\edge}\rt)+k\lt(\preloc{\edge}\rt)}\lt|X_{ij}\rt|\leq \frac{u^\pr_i\lt(\edge\rt)+l^\pr_i\lt(\edge\rt)}{2}
\end{split}\\
\begin{split}
l^\pr(\edge)\leq u^\pr(\edge)
\end{split}\\
& \maxaffinefunc_{\edge}^{post}\lt(l^\pr(\edge),\stay^-\lt(\postloc{\edge}\rt)\rt)\geq
l\lt(\postloc{\edge}\rt)~\text{and}~\minaffinefunc_{\edge}^{post}\lt(u^\pr(\edge),\stay^+\lt(\postloc{\edge}\rt)\rt)\leq u\lt(\postloc{\edge}\rt).
\end{align}
\end{lemma}
\begin{proof}
{\color{red} TODO}
\end{proof}


