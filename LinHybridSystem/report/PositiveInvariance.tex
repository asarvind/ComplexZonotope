

In this section, we first derive a sufficient condition for positive
invariance of an augmented complex zonotope.  Also, we state
conditions for containment of an initial set and satisfaction of
polytopic safety constraints.  Latter, we explain how find the
augmented complex zontope based on these conditions.

Earlier, we had computed the linear transformations and Minkowki sums
of augmented complex zonotope and possible overapproximations of their
intersection with subparalleotopic constraints.  Accordingly, we can
compute the overapproximation of the reachable set of an augmented
complex zonotope as another augmented complex zonotope.  Then, we
utilize the partial order given in Definition~\ref{defn:gcz-order} to
  deduce a sufficient condition for positive invariance, as follows.
%
\begin{lemma}[Positive invariance]
  Let us consider a state set $\hybridset:\locationset\ra\realset^n$
  whose projection in each location $\loc\in\locationset$ is
  $\real\lt(\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$.
  Let us consider that the additive input for an intralocation
  transition in any location $\loc\in\locationset$ is overapproximated
  as $\inputset(\loc)\subseteq
  \gcz{V^{in}(\loc)}{c^{in}(\loc)}{s^{in}(\loc)}{W^{in}(\loc)}{l^{in}(\loc)}{u^{in}(\loc)}$.
  Similarly, let the additive input for an interlocation transition
  along any edge $\edge\in\edgeset$, be overapproximated as
  $\edgeinp(\edge)\subseteq
  \gcz{V^{in}(\edge)}{c^{in}(\edge)}{s^{in}(\edge)}{W^{in}(\edge)}{l^{in}(\edge)}{u^{in}(\edge)}$.
  The condition for positive invariance of the state set $\hybridset$
  is described as follows.
\begin{enumerate}
\item For any location $\loc\in\locationset$, the inclusion
  $\locationtransition{\loc}\lt(\hybridset(\loc)\rt)\subseteq
  \hybridset(\loc)$ holds if all of the below statements are
  collectively true.
\begin{align}~\label{eqn:locinv}
\begin{split}
& \pinv{\ptemplate}(\loc)c(\loc) = 0~\text{and there exists a complex vector}~
  c^\pr(\loc)~\text{and}\\
& \text{real
    vectors}~s^\pr(\loc),l^\pr(\loc),u^\pr(\loc),l^\dpr(\loc),u^\dpr(\loc)~\text{such
    that}\\
\end{split}
\end{align}
\vspace{-1.5em}
\begin{align}
& c^\pr(\loc) = \map(\loc)c(\loc)+c^{in}(\loc),~~s^\pr(\loc) =
  \ColumnJoin{s(\loc)}{s^{in}(\loc)}
\end{align}
\vspace{-1.5em}
\begin{align}
& l^\pr(\loc) =
  \ColumnJoin{\maxaffine{l(\loc)}{\stay^-(\loc)}}{~~~~~~~~~l^{in}(\loc)~~~},~~u^\pr
  =
  \ColumnJoin{\minaffine{u(\loc)}{\stay^+(\loc)}}{~~~~~~~~~u^{in}(\loc)~~~}
\end{align}
\vspace{-1.5em}
\begin{align}
& \lt\{\Calign{\gcz{\lt[\map(\loc)V(\loc)~~V^{in}(\loc)\rt]}{c^\pr(\loc)}{s^\pr(\loc)}
          {\lt[\map(\loc)\pinv{\ptemplate}(\loc)~~W^{in}(\loc)\rt]}{l^\pr(\loc)}{u^\pr(\loc)}}
 {~~\order
   \gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l^\dpr(\loc)}{u^\dpr(\loc)}}\rt.
\end{align}
\vspace{-1.5em}
\begin{align}
& \maxaffine{l^\dpr(\loc)}{\stay^-(\loc)}\geq l(\loc)~\text{and}~~
\minaffine{u^\dpr(\loc)}{\stay^+(\loc)}\leq u(\loc).
 \end{align}
\item For any edge $\edge\in\edgeset$, the inclusion
  $\edgetransition{\edge}\lt(\hybridset\lt(\preloc{\edge}\rt)\rt)
  \subseteq \hybridset\lt(\postloc{\edge}\rt)$ holds if 
  all of the below statements are collectively true.
\begin{align}~\label{eqn:edgeinv}
\begin{split}
& \pinv{\ptemplate}\lt(\preloc{\edge}\rt)c\lt(\preloc{\edge}\rt) =
  0~\text{and there exists a complex
  vector}~c^\pr(\postloc{\edge})~\text{and}\\
& \text{real
    vectors}~s^\pr(\postloc{\edge}),l^\pr(\postloc{\edge}),u^\pr(\postloc{\edge}),l^\dpr(\postloc{\edge}),u^\dpr(\postloc{\edge})~~\text{such
  that}
\end{split}
\end{align}
\vspace{-1.5em}
\begin{align}
& c^\pr(\edge) = \edgemap(\edge)c(\preloc{\edge})+c^{in}(\edge),~~s^\pr(\edge) =
  \ColumnJoin{s(\preloc{\edge})}{s^{in}(\edge)}
\end{align}
\vspace{-1.5em}
\begin{align}
& l^\pr(\edge) =
  \ColumnJoin{\maxaffine{l(\preloc{\edge})}{\stay^-(\preloc{\edge})\bigvee\loweredgebound{\edge}}}{~~~~~~~~~l^{in}(\edge)~~~},~~u^\pr =
  \ColumnJoin{\minaffine{u(\preloc{\edge})}{\stay^+(\preloc{\edge})\bigwedge\upperedgebound{\edge}}}{~~~~~~~~~u^{in}(\edge)~~~}
\end{align}
\vspace{-1.5em}
\begin{align}
& \lt\{\Calign{\gcz{\lt[\map(\edge)V(\preloc{\edge})~~V^{in}(\edge)\rt]}{c^\pr(\edge)}{s^\pr(\edge)}
          {\lt[\map(\edge)\pinv{\ptemplate}(\preloc{\edge})~~W^{in}(\edge)\rt]}{l^\pr(\edge)}{u^\pr(\edge)}}
 {~~\order
   \gcz{V(\postloc{\edge})}{c(\postloc{\edge})}{s(\postloc{\edge})}{\pinv{\ptemplate}(\postloc{\edge})}{l^\dpr(\edge)}{u^\dpr(\edge)}}\rt.
\end{align}
\vspace{-1.5em}
\begin{align}
& \maxaffine{l^\dpr(\edge)}{\stay^-(\postloc{\edge})}\geq l(\postloc{\edge})~\text{and}~~
\minaffine{u^\pr(\edge)}{\stay^+(\postloc{\edge})}\leq u(\postloc{\edge}).
\end{align}
\vspace{-1.5em}
\end{enumerate}
\end{lemma}
%
Next, we state a sufficient condition for an augmented complex
zonotopic state set to contain an initial set overapproximated by an
augmented complex zonotope.  This is just the partial order between
the augmented complex zonotopes (Lemma~\ref{lem:gcz-gcz}).
\begin{lemma}
  Let $\mc{I}$ and $\hybridset$ be two state sets whose projections in
  each location $\loc\in\locationset$ are respectively
  $\mc{I}(\loc)=\real\lt(\gcz{V^I(\loc)}{c^I(\loc)}{s^I(\loc)}{W^I(\loc)}{l^I(\loc)}{u^I(\loc)}\rt)$
  and $\hybridset(\loc) =
  \real\lt(\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$.
  Then $\forall\loc\in\locationset,~\mc{I}(\loc)\subseteq
  \hybridset(\loc)$ if $\forall\loc\in\locationset$,
\begin{align}~\label{eqn:initcont}
\gcz{V^I(\loc)}{c^I(\loc)}{s^I(\loc)}{W^I(\loc)}{l^I(\loc)}{u^I(\loc)}\order\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}.
\end{align}
\end{lemma}
%
For satisfaction of polytopic safety constraints by an augmented
complex zonotope, the following lemma gives a sufficient condition,
which is based on Lemma~\ref{lem:polylimits-acz}.
%
\begin{lemma}
  Let us consider a state set $\hybridset$ whose projection in each
  location $\loc \in\locationset$ is $\hybridset(\loc) =
  \real\lt(\gcz{V_{n\times
      m(\loc)}(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$.
  Let us consider a polytopic state set
  $\safeset:\locationset\ra\realset^n$ described as $\forall
  \loc\in\locationset,~\safeset(\loc)=\polytope{T(\loc)}{d(\loc)}$. Then
  for any location $\loc\in\locationset$, $\hybridset(\loc)\subseteq
  \safeset(\loc)$ if,
\begin{align}~\label{eqn:safecont}
T(\loc)\lt(c(\loc)+\pinv{\ptemplate}(\loc)\lt(\frac{u(\loc)+l(\loc)}{2}\rt)\rt)+\lt|T\lt[V(\loc),~\pinv{\ptemplate}(\loc)\rt]\rt|\ColumnJoin{\hspace{1.5em}s}{\frac{u(\loc)-l(\loc)}{2}}\leq d(\loc).
\end{align}
\end{lemma}
%
Consolidating the previous results in this section, we state following
sufficient condition for positive invariance, along with satisfaction
of a given set of polytopic safety constraints and containment of an initial set.
%
\begin{theorem}~\label{thm:main} Let us consider that the additive input sets for the intralocation
  transition in any location $\loc\in\locationset$ and interlocation
  transition along any edge $\edge\in\edgeset$ be overapproximated as
  $\inputset(\loc)\subseteq \gcz{V^{in}(\loc)}{c^{in}(\loc)}{s^{in}(\loc)}{W^{in}(\loc)}{l^{in}(\loc)}{u^{in}(\loc)}$
  and
  $\edgeinp(\edge)\subseteq \gcz{V^{in}(\edge)}{c^{in}(\edge)}{s^{in}(\edge)}{W^{in}(\edge)}{l^{in}(\edge)}{u^{in}(\edge)}$,
  respectively.  Let $\hybridset$ be a state set such that for any
  $\loc\in\locationset$, $\hybridset(\loc)
  = \real\lt(\gcz{V(\loc)}{c(\loc)}{s(\loc)}{\pinv{\ptemplate}(\loc)}{l(\loc)}{u(\loc)}\rt)$.
  Let the initial in any lcoation $\loc\in\locationset$ be
  $\mc{I}(\loc)=\real\lt(\gcz{V^I(\loc)}{c^I(\loc)}{s^I(\loc)}{W}{l^I(\loc)}{u^I(\loc)}\rt)$
  and polytopic safe set be
  $\forall \loc\in\locationset,~\safeset(\loc)=\polytope{T(\loc)}{d(\loc)}$.
  Then the state set $\hybridset$ is a positive invariant, satisfies
  the given safety constraints and contains the given initial set if
  $\forall \loc\in\locationset$ and $\forall \edge\in\edgeset$, all of
  the Equations[\ref{eqn:locinv}-\ref{eqn:safecont}] are collectively
  true.
\end{theorem}

\tbf{Solving the conditions.}  Firstly, we note that the secondary
template in a location is predefined as the pseudoinverse of the
subparallelotopic template in the location, in accordance with
Theorem~\ref{thm:main}.  Then, we observe that for a fixed primary
template in each location, the set of
Equations[\ref{eqn:locinv}-\ref{eqn:safecont}] are equivalent to
second order conic constraints on the primary offset, upper and lower
interval bounds in each location and some additional varaibles.  This
can be inferred from the~Lemma~\ref{lem:zon-socc} and the fact that
the min and max approximation functions we defined earlier are
affine. So, we first fix the primary template in each location and
solve the aforementioned constraints as a convex program.  The choice
of the primary template is explained below.  But first, we note that
the primary template can be soundly refined by adding any set of
complex vectors.

\tbf{Refinement of primary template.}  Adding any set of complex vectors to
the primary template increases the chance of computing the desired
invariant, because the scaling factors are adjusted accordingly by the
optimizer.  However, the computational complexity increases with the
size of the template.

\tbf{Choosing the primary template.}  We may collect all or some of
the following vectors in the primary template.
%
\begin{enumerate}
\item Eigenvectors of the transformation matrices of the affine maps
  of the intralocation and interlocation transitions and also
  eigenvectors of products of the matrices.  This is because the
  eigenvectors can capture stable directions of the dynamics.
\item The primary and secondary templates of the augmented complex
  zonotopes which overapproimate the additive disturbance input sets.
  Also, we can incorporate the products of the linear matrices of the
  affine maps with these templates.  This is because the input set and
  its transformations are added in reachable set
  computation.
\item Any other vectors based on the discretion of the user can be
  added.  As remarked earlier, adding any set of vectors to the
  primary template increases the chance of computing a desired
  invariant, but at a computational expense.
\end{enumerate}
